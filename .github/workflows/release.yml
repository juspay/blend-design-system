name: Release

on:
    push:
        branches:
            - main
            - dev
            - fix/release-workflow
        paths-ignore:
            - 'docs/CHANGELOG.md'
    workflow_dispatch:
        inputs:
            version_type:
                description: 'Version bump type'
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major
            dry_run:
                description: 'Dry run (skip publishing)'
                required: false
                default: false
                type: boolean

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    release:
        name: Publish Release
        runs-on: ubuntu-latest
        environment: npm
        outputs:
            version: ${{ steps.bump_version.outputs.new_version }}
            tag: ${{ steps.bump_version.outputs.tag }}
            dry_run: ${{ steps.config.outputs.dry_run }}
            is_beta: ${{ steps.bump_version.outputs.is_beta }}

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GH_BOT_TOKEN }}

            - name: Debug Git Context
              run: |
                  echo "Branch: $GITHUB_REF_NAME"
                  echo "Event: $GITHUB_EVENT_NAME"
                  echo "Actor: $GITHUB_ACTOR"
                  git status
                  git log -1 --pretty=full

            - name: Check if should skip release
              id: skip_check
              run: |
                  COMMIT_MESSAGE=$(git log -1 --pretty=%B)
                  echo "Commit message: $COMMIT_MESSAGE"

                  if [[ "$COMMIT_MESSAGE" == *"[skip ci]"* ]] || [[ "$COMMIT_MESSAGE" == *"chore(release):"* ]]; then
                    if [[ "${GITHUB_REF_NAME}" == "main" && "$COMMIT_MESSAGE" == *"chore(release):"* ]]; then
                      echo "Release commit on main branch - proceeding with stable release"
                      echo "should_skip=false" >> $GITHUB_OUTPUT
                    else
                      echo "Skipping release workflow"
                      echo "should_skip=true" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "should_skip=false" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Node.js 22 and pnpm
              if: steps.skip_check.outputs.should_skip != 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: 'https://registry.npmjs.org'

            - name: Enable corepack & install deps
              if: steps.skip_check.outputs.should_skip != 'true'
              run: |
                  corepack enable
                  pnpm install --frozen-lockfile

            - name: Configure Dry Run
              if: steps.skip_check.outputs.should_skip != 'true'
              id: config
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
                    echo "dry_run=true" >> $GITHUB_OUTPUT
                  else
                    echo "dry_run=false" >> $GITHUB_OUTPUT
                  fi

            - name: Get Current Version
              if: steps.skip_check.outputs.should_skip != 'true'
              id: current_version
              run: |
                  CURRENT=$(node -p "require('./packages/blend/package.json').version")
                  echo "version=$CURRENT" >> $GITHUB_OUTPUT
                  echo "Current version: $CURRENT"

            - name: Clean Existing Tags
              if: steps.skip_check.outputs.should_skip != 'true'
              run: |
                  git tag -l | xargs -r git tag -d
                  git fetch --tags

            - name: Bump Version
              if: steps.skip_check.outputs.should_skip != 'true'
              id: bump_version
              run: |
                  set -x
                  cd packages/blend
                  BRANCH="${GITHUB_REF_NAME}"
                  VERSION_TYPE="${{ inputs.version_type || 'patch' }}"
                  CURRENT_VERSION=$(node -p "require('./package.json').version")

                  echo "Branch: $BRANCH"
                  echo "Version type: $VERSION_TYPE"
                  echo "Current version: $CURRENT_VERSION"

                  if [[ "$BRANCH" == "dev" ]]; then
                    if [[ "$CURRENT_VERSION" == *"-beta" ]]; then
                      NEW_VERSION="$CURRENT_VERSION"
                      echo "Already beta: $NEW_VERSION"
                    else
                      npm version "$VERSION_TYPE" --no-git-tag-version
                      BUMPED_VERSION=$(node -p "require('./package.json').version")
                      NEW_VERSION="${BUMPED_VERSION}-beta"
                      npm pkg set version="$NEW_VERSION"
                    fi
                    echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "is_beta=true" >> $GITHUB_OUTPUT
                    echo "npm_tag=beta" >> $GITHUB_OUTPUT
                  elif [[ "$BRANCH" == "main" ]]; then
                    if [[ "$CURRENT_VERSION" == *"-beta" ]]; then
                      STABLE_VERSION="${CURRENT_VERSION%-beta}"
                      npm pkg set version="$STABLE_VERSION"
                      NEW_VERSION="$STABLE_VERSION"
                    else
                      npm version "$VERSION_TYPE" --no-git-tag-version
                      NEW_VERSION=$(node -p "require('./package.json').version")
                    fi
                    echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "is_beta=false" >> $GITHUB_OUTPUT
                    echo "npm_tag=latest" >> $GITHUB_OUTPUT
                  elif [[ "$BRANCH" == "fix/release-workflow" ]]; then
                    if [[ "$CURRENT_VERSION" == *"-beta" ]]; then
                      STABLE_VERSION="${CURRENT_VERSION%-beta}"
                      npm pkg set version="$STABLE_VERSION"
                      NEW_VERSION="$STABLE_VERSION"
                    else
                      npm version "$VERSION_TYPE" --no-git-tag-version
                      NEW_VERSION=$(node -p "require('./package.json').version")
                    fi
                    echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "is_beta=false" >> $GITHUB_OUTPUT
                    echo "npm_tag=latest" >> $GITHUB_OUTPUT
                  fi

            - name: Generate Changelog
              if: steps.skip_check.outputs.should_skip != 'true'
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  mkdir -p docs
                  echo "# Changelog for v$VERSION" > docs/CHANGELOG.md
                  echo "" >> docs/CHANGELOG.md
                  if [[ -n "$LAST_TAG" ]]; then
                    git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> docs/CHANGELOG.md
                  else
                    git log -n 20 --pretty=format:"- %s (%h)" >> docs/CHANGELOG.md
                  fi

            - name: Format Generated Files
              if: steps.skip_check.outputs.should_skip != 'true'
              run: pnpm format

            - name: Build Package
              if: steps.skip_check.outputs.should_skip != 'true'
              run: pnpm --filter @juspay/blend-design-system build

            - name: Commit & Push Changes
              if: steps.skip_check.outputs.should_skip != 'true' && steps.config.outputs.dry_run != 'true'
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  git config user.name "Release Bot"
                  git config user.email "release-bot@example.com"
                  git add packages/blend/package.json docs/CHANGELOG.md
                  git commit -m "chore(release): v$VERSION [skip ci]" || echo "No changes to commit"
                  git push origin HEAD
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_BOT_TOKEN }}

            - name: Create Release Tag
              if: steps.skip_check.outputs.should_skip != 'true' && steps.config.outputs.dry_run != 'true'
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  TAG="v$VERSION"
                  git tag "$TAG" -m "Release $TAG"
                  git push origin "$TAG"

            - name: Verify NPM Token
              if: steps.skip_check.outputs.should_skip != 'true'
              run: |
                  if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
                    echo "NPM_TOKEN secret is not set!"
                    exit 1
                  fi
                  npm whoami || echo "NPM authentication failed"
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Publish to NPM
              if: steps.skip_check.outputs.should_skip != 'true' && steps.config.outputs.dry_run != 'true'
              run: |
                  cd packages/blend
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
                  NPM_TAG="${{ steps.bump_version.outputs.npm_tag }}"
                  echo "Publishing $PACKAGE_NAME@$NEW_VERSION"
                  if npm view "$PACKAGE_NAME@$NEW_VERSION" version >/dev/null 2>&1; then
                    echo "Version exists, skipping"
                    exit 0
                  fi
                  npm publish --access public --tag "$NPM_TAG"
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Create GitHub Release
              if: steps.skip_check.outputs.should_skip != 'true' && steps.config.outputs.dry_run != 'true'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.bump_version.outputs.tag }}
                  name: Release ${{ steps.bump_version.outputs.tag }}
                  body_path: docs/CHANGELOG.md
                  draft: false
                  prerelease: ${{ steps.bump_version.outputs.is_beta == 'true' }}
