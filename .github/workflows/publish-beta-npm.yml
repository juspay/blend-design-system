name: Publish Beta to NPM

on:
    workflow_dispatch:
        inputs:
            confirm_publish:
                description: 'Type "PUBLISH" to confirm publishing to NPM'
                required: true
                type: string

concurrency:
    group: publish-beta-npm-${{ github.ref }}
    cancel-in-progress: true

jobs:
    publish-beta:
        name: Publish Beta Version to NPM
        runs-on: ubuntu-latest
        environment: npm
        if: github.ref == 'refs/heads/staging' && github.event.inputs.confirm_publish == 'PUBLISH'

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js 22 and pnpm
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: 'https://registry.npmjs.org'
                  scope: '@juspay'
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Enable corepack & install deps
              run: |
                  corepack enable
                  pnpm install --frozen-lockfile

            - name: Verify NPM Token and Authentication
              run: |
                  if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
                    echo "âŒ ERROR: NPM_TOKEN secret is not set!"
                    echo ""
                    echo "Please configure NPM_TOKEN secret:"
                    echo "1. Go to GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions"
                    echo "2. Go to Environments â†’ npm â†’ Secrets"
                    echo "3. Add or update NPM_TOKEN secret"
                    exit 1
                  else
                    echo "âœ… NPM_TOKEN secret is configured"
                  fi

                  echo "ðŸ” Testing NPM authentication..."

                  # Test authentication
                  if npm whoami; then
                    NPM_USER=$(npm whoami)
                    echo "âœ… Successfully authenticated as: $NPM_USER"
                    
                    # Check if user has access to @juspay scope
                    echo "ðŸ” Checking @juspay scope access..."
                    if npm access ls packages @juspay/blend-design-system 2>/dev/null; then
                      echo "âœ… Has access to @juspay scope"
                    else
                      echo "âš ï¸  Warning: Cannot verify @juspay scope access"
                      echo "   This might be normal if you're not an org member"
                      echo "   The publish will fail if you don't have permissions"
                    fi
                  else
                    echo "âŒ ERROR: NPM authentication failed!"
                    echo ""
                    echo "Possible issues:"
                    echo "  1. NPM_TOKEN is expired or invalid"
                    echo "  2. Token doesn't have publish permissions"
                    echo "  3. Token is not configured correctly in GitHub secrets"
                    echo ""
                    echo "To fix:"
                    echo "  1. Generate a new NPM access token:"
                    echo "     https://www.npmjs.com/settings/YOUR_USERNAME/tokens"
                    echo "  2. Ensure token type is 'Automation' (not 'Read-only')"
                    echo "  3. Ensure you're a member of @juspay organization on NPM"
                    echo "  4. Update NPM_TOKEN secret in GitHub:"
                    echo "     Settings â†’ Secrets â†’ Actions â†’ Environments â†’ npm"
                    echo ""
                    echo "Token requirements:"
                    echo "  - Type: Automation (for CI/CD)"
                    echo "  - Permissions: Read and publish packages"
                    echo "  - Scope: Must have access to @juspay organization"
                    exit 1
                  fi
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Verify Beta Version
              id: verify_version
              run: |
                  cd packages/blend
                  CURRENT_VERSION=$(node -p "require('./package.json').version")

                  # Check for new format: X.Y.Z-beta.N
                  if [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
                    BASE_VERSION="${BASH_REMATCH[1]}"
                    BETA_NUMBER="${BASH_REMATCH[2]}"
                    echo "Verified beta version: $CURRENT_VERSION (base: $BASE_VERSION, beta #$BETA_NUMBER)"
                    echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
                    echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
                    echo "beta_number=$BETA_NUMBER" >> $GITHUB_OUTPUT
                    echo "version_format=new" >> $GITHUB_OUTPUT
                  # Check for old format: X.Y.Z-beta
                  elif [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta$ ]]; then
                    BASE_VERSION="${BASH_REMATCH[1]}"
                    echo "Verified beta version (old format): $CURRENT_VERSION"
                    echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
                    echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
                    echo "beta_number=0" >> $GITHUB_OUTPUT
                    echo "version_format=old" >> $GITHUB_OUTPUT
                  else
                    echo "ERROR: Current version ($CURRENT_VERSION) is not a beta version!"
                    echo "Expected format: X.Y.Z-beta.N (e.g., 1.0.0-beta.0) or X.Y.Z-beta"
                    echo "This workflow should only be used to publish beta versions."
                    exit 1
                  fi

            - name: Build Package
              run: pnpm --filter @juspay/blend-design-system build

            - name: Check Package Existence and Version
              id: check_published
              run: |
                  cd packages/blend
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  VERSION="${{ steps.verify_version.outputs.version }}"

                  echo "ðŸ“¦ Checking package: $PACKAGE_NAME"
                  echo "ðŸ“Œ Checking version: $VERSION"

                  # Check if package exists at all
                  if npm view "$PACKAGE_NAME" name 2>/dev/null >/dev/null; then
                    echo "âœ… Package $PACKAGE_NAME exists in NPM registry"
                    PACKAGE_EXISTS=true
                  else
                    echo "âš ï¸  Package $PACKAGE_NAME does not exist in NPM registry yet"
                    echo "   This will be the first publish of this package"
                    PACKAGE_EXISTS=false
                  fi

                  # Check if specific version exists
                  if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null >/dev/null; then
                    echo "already_published=true" >> $GITHUB_OUTPUT
                    echo "package_exists=true" >> $GITHUB_OUTPUT
                    echo "âš ï¸  Version $VERSION already exists on NPM"
                  else
                    echo "already_published=false" >> $GITHUB_OUTPUT
                    if [[ "$PACKAGE_EXISTS" == "true" ]]; then
                      echo "package_exists=true" >> $GITHUB_OUTPUT
                    else
                      echo "package_exists=false" >> $GITHUB_OUTPUT
                    fi
                    echo "âœ… Version $VERSION is not yet published - ready to publish"
                  fi
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Publish Beta to NPM
              if: steps.check_published.outputs.already_published != 'true'
              run: |
                  cd packages/blend
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  VERSION="${{ steps.verify_version.outputs.version }}"
                  PACKAGE_EXISTS="${{ steps.check_published.outputs.package_exists }}"

                  echo "ðŸš€ Publishing $PACKAGE_NAME@$VERSION to NPM with beta tag"

                  if [[ "$PACKAGE_EXISTS" == "false" ]]; then
                    echo "ðŸ“¦ This is the first publish of this package"
                    echo "   Creating new package: $PACKAGE_NAME"
                  fi

                  # Ensure we're authenticated
                  echo "ðŸ” Verifying authentication before publish..."
                  if ! npm whoami; then
                    echo "âŒ ERROR: Not authenticated to NPM"
                    echo "NPM token may have expired. Please update NPM_TOKEN secret."
                    exit 1
                  fi

                  # Verify package.json configuration
                  echo "ðŸ“‹ Verifying package.json configuration..."
                  PACKAGE_JSON_VERSION=$(node -p "require('./package.json').version")
                  PACKAGE_JSON_NAME=$(node -p "require('./package.json').name")

                  if [[ "$PACKAGE_JSON_VERSION" != "$VERSION" ]]; then
                    echo "âŒ ERROR: Version mismatch!"
                    echo "Expected: $VERSION"
                    echo "Found in package.json: $PACKAGE_JSON_VERSION"
                    exit 1
                  fi

                  if [[ "$PACKAGE_JSON_NAME" != "$PACKAGE_NAME" ]]; then
                    echo "âŒ ERROR: Package name mismatch!"
                    echo "Expected: $PACKAGE_NAME"
                    echo "Found in package.json: $PACKAGE_JSON_NAME"
                    exit 1
                  fi

                  echo "âœ… Package.json configuration verified"

                  # Publish with explicit access and tag
                  echo "ðŸ“¤ Publishing $PACKAGE_NAME@$VERSION to NPM with beta tag..."

                  # Try publishing
                  PUBLISH_OUTPUT=$(npm publish --access public --tag beta 2>&1)
                  PUBLISH_EXIT_CODE=$?

                  if [[ $PUBLISH_EXIT_CODE -eq 0 ]]; then
                    echo "âœ… Successfully published $PACKAGE_NAME@$VERSION to NPM with beta tag"
                  else
                    echo "âŒ ERROR: Failed to publish package"
                    echo ""
                    echo "Publish output:"
                    echo "$PUBLISH_OUTPUT"
                    echo ""
                    echo "Common issues and solutions:"
                    echo ""
                    echo "1. NPM Token Issues:"
                    echo "   - Token expired: Generate new token at https://www.npmjs.com/settings/YOUR_USERNAME/tokens"
                    echo "   - Token type: Must be 'Automation' (not 'Read-only')"
                    echo "   - Update NPM_TOKEN in GitHub: Settings â†’ Secrets â†’ Actions â†’ Environments â†’ npm"
                    echo ""
                    echo "2. Permission Issues:"
                    echo "   - Must be member of @juspay organization on NPM"
                    echo "   - Check org membership: https://www.npmjs.com/org/juspay"
                    echo "   - Token must have publish permissions for @juspay scope"
                    echo ""
                    echo "3. Version Already Exists:"
                    echo "   - Check if version exists: npm view $PACKAGE_NAME@$VERSION"
                    echo "   - If exists, increment beta version using 'Create Beta Release' workflow"
                    echo ""
                    echo "4. Package Configuration:"
                    echo "   - name: $PACKAGE_NAME"
                    echo "   - version: $VERSION"
                    echo "   - publishConfig.access: public (should be in package.json)"
                    echo ""
                    echo "5. Network/Registry Issues:"
                    echo "   - Check NPM registry: npm config get registry"
                    echo "   - Should be: https://registry.npmjs.org"
                    exit 1
                  fi
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Calculate Stable Version
              if: steps.check_published.outputs.already_published != 'true'
              id: stable_version
              run: |
                  STABLE_VERSION="${{ steps.verify_version.outputs.base_version }}"
                  echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
                  echo "Stable version will be: $STABLE_VERSION"

            - name: Create Success Summary
              if: steps.check_published.outputs.already_published != 'true'
              run: |
                  echo "## ðŸŽ‰ Beta Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Package**: \`@juspay/blend-design-system\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Version**: \`${{ steps.verify_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Beta Number**: \`#${{ steps.verify_version.outputs.beta_number }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**NPM Tag**: \`beta\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Installation" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "# Install latest beta" >> $GITHUB_STEP_SUMMARY
                  echo "npm install @juspay/blend-design-system@beta" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "# Install specific beta version" >> $GITHUB_STEP_SUMMARY
                  echo "npm install @juspay/blend-design-system@${{ steps.verify_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”„ Beta Iteration Workflow" >> $GITHUB_STEP_SUMMARY
                  echo "| Current | If Issues Found | When Stable |" >> $GITHUB_STEP_SUMMARY
                  echo "|---------|-----------------|-------------|" >> $GITHUB_STEP_SUMMARY
                  echo "| \`${{ steps.verify_version.outputs.version }}\` | Run 'Create Beta Release' with increment | Promote to \`${{ steps.stable_version.outputs.stable_version }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
                  echo "- âœ… Beta version is now live on NPM" >> $GITHUB_STEP_SUMMARY
                  echo "- âœ… GitHub beta release is available" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ§ª Test the beta version thoroughly" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ” If issues found: Run 'Create Beta Release' workflow with 'Increment existing beta version' = true" >> $GITHUB_STEP_SUMMARY
                  echo "- âœ… When ready: Run 'Promote Beta to Stable' workflow to create stable release" >> $GITHUB_STEP_SUMMARY

            - name: Verify NPM Package After Publish
              if: steps.check_published.outputs.already_published != 'true'
              run: |
                  cd packages/blend
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  VERSION="${{ steps.verify_version.outputs.version }}"

                  echo "Verifying published beta package..."
                  sleep 10  # Wait for NPM to propagate

                  PUBLISHED_VERSION=$(npm view "$PACKAGE_NAME@beta" version 2>/dev/null || echo "")
                  if [[ "$PUBLISHED_VERSION" == "$VERSION" ]]; then
                    echo "âœ… Successfully verified: $PACKAGE_NAME@$VERSION is live on NPM with beta tag"
                  else
                    echo "âš ï¸  Warning: Expected $VERSION but NPM shows $PUBLISHED_VERSION for beta tag"
                    echo "This might be due to NPM propagation delay"
                  fi

                  # Also check if we can download and list the package
                  echo "ðŸ“¦ Testing package download..."
                  npm view "$PACKAGE_NAME@beta" --json > /tmp/package-info.json || echo "Could not download package info"

                  if [[ -f /tmp/package-info.json ]]; then
                    echo "âœ… Package info downloaded successfully"
                    echo "ðŸ“‹ Package details:"
                    cat /tmp/package-info.json | jq -r '.name, .version, .description' 2>/dev/null || echo "Basic package info verified"
                  fi

            - name: List All Beta Versions
              if: steps.check_published.outputs.already_published != 'true'
              run: |
                  cd packages/blend
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  BASE_VERSION="${{ steps.verify_version.outputs.base_version }}"

                  echo "ðŸ“‹ All beta versions for $BASE_VERSION:"
                  npm view "$PACKAGE_NAME" versions --json 2>/dev/null | jq -r '.[]' | grep "$BASE_VERSION-beta" || echo "No previous betas found"

            - name: Skip Publishing (Already Published)
              if: steps.check_published.outputs.already_published == 'true'
              run: |
                  echo "Version ${{ steps.verify_version.outputs.version }} is already published on NPM"
                  echo "Skipping publish step"

                  echo "## âš ï¸ Version Already Published" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Version \`${{ steps.verify_version.outputs.version }}\` is already on NPM." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "To publish a new beta version:" >> $GITHUB_STEP_SUMMARY
                  echo "1. Run 'Create Beta Release' workflow with 'Increment existing beta version' = true" >> $GITHUB_STEP_SUMMARY
                  echo "2. Then run this workflow again" >> $GITHUB_STEP_SUMMARY

            - name: Troubleshooting Guide (On Failure)
              if: failure()
              run: |
                  echo "## âŒ Publishing Failed - Troubleshooting Guide" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”´ Most Common Issue: NPM Token Expired or Invalid" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Error**: \`Access token expired or revoked\` or \`404 Not Found\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Solution Steps:**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "1. **Generate New NPM Token:**" >> $GITHUB_STEP_SUMMARY
                  echo "   - Go to: https://www.npmjs.com/settings/YOUR_USERNAME/tokens" >> $GITHUB_STEP_SUMMARY
                  echo "   - Click 'Generate New Token'" >> $GITHUB_STEP_SUMMARY
                  echo "   - **Token Type**: Select 'Automation' (NOT 'Read-only')" >> $GITHUB_STEP_SUMMARY
                  echo "   - **Expiration**: Set appropriate expiration (or 'Never expire' for CI/CD)" >> $GITHUB_STEP_SUMMARY
                  echo "   - Copy the token immediately (you won't see it again)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Update GitHub Secret:**" >> $GITHUB_STEP_SUMMARY
                  echo "   - Go to: Repository â†’ Settings â†’ Secrets and variables â†’ Actions" >> $GITHUB_STEP_SUMMARY
                  echo "   - Click on 'Environments' tab" >> $GITHUB_STEP_SUMMARY
                  echo "   - Click on 'npm' environment" >> $GITHUB_STEP_SUMMARY
                  echo "   - Update or add 'NPM_TOKEN' secret with the new token" >> $GITHUB_STEP_SUMMARY
                  echo "   - Click 'Update secret'" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "3. **Verify Organization Membership:**" >> $GITHUB_STEP_SUMMARY
                  echo "   - Ensure you're a member of @juspay organization on NPM" >> $GITHUB_STEP_SUMMARY
                  echo "   - Check: https://www.npmjs.com/org/juspay" >> $GITHUB_STEP_SUMMARY
                  echo "   - Token creator must have publish permissions for @juspay scope" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Other Common Issues:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### 404 Not Found Error" >> $GITHUB_STEP_SUMMARY
                  echo "- Usually caused by expired/invalid token" >> $GITHUB_STEP_SUMMARY
                  echo "- If token is valid, check organization membership" >> $GITHUB_STEP_SUMMARY
                  echo "- Verify token has 'Automation' type (not 'Read-only')" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### Permission Denied" >> $GITHUB_STEP_SUMMARY
                  echo "- Token doesn't have publish permissions" >> $GITHUB_STEP_SUMMARY
                  echo "- User is not a member of @juspay organization" >> $GITHUB_STEP_SUMMARY
                  echo "- Organization settings restrict publishing" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### Version Already Exists" >> $GITHUB_STEP_SUMMARY
                  echo "- Check if version exists: \`npm view @juspay/blend-design-system@VERSION\`" >> $GITHUB_STEP_SUMMARY
                  echo "- If exists, increment beta version using 'Create Beta Release' workflow" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Quick Verification:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "After updating the token, verify locally:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "# Set token temporarily" >> $GITHUB_STEP_SUMMARY
                  echo "export NPM_TOKEN='your-token-here'" >> $GITHUB_STEP_SUMMARY
                  echo "npm config set //registry.npmjs.org/:_authToken \$NPM_TOKEN" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "# Test authentication" >> $GITHUB_STEP_SUMMARY
                  echo "npm whoami" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "# Check package access" >> $GITHUB_STEP_SUMMARY
                  echo "npm view @juspay/blend-design-system" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
