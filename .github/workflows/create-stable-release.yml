name: Create Stable Release (DEPRECATED)

# This workflow is DEPRECATED. Please use the new workflow:
# - promote-to-stable.yml: Promote tested beta to stable from staging branch
#
# The new workflow follows the improved beta versioning system:
# - Supports incremental beta versions: X.Y.Z-beta.0, beta.1, beta.2, etc.
# - Promotes tested beta to stable via promote-to-stable.yml
# - Cleaner branch strategy with proper staging → main flow
#
# New Workflow:
# 1. create-beta-release.yml: Create beta from staging
# 2. publish-beta-npm.yml: Publish beta to NPM
# 3. promote-to-stable.yml: Promote beta to stable (creates PR to main)
# 4. publish-stable-npm.yml: Publish stable from main to NPM
#
# See docs/RELEASE_WORKFLOW.md for complete documentation.

on:
    # Disabled automatic triggers - only manual for emergency use
    workflow_dispatch:
        inputs:
            confirm_stable:
                description: 'Type "DEPRECATED_USE_PROMOTE_TO_STABLE" to confirm using deprecated workflow'
                required: true
                type: string

concurrency:
    group: create-stable-release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    deprecation-warning:
        name: Deprecation Warning
        runs-on: ubuntu-latest
        if: github.event.inputs.confirm_stable != 'DEPRECATED_USE_PROMOTE_TO_STABLE'

        steps:
            - name: Show Deprecation Notice
              run: |
                  echo "⚠️  DEPRECATION WARNING ⚠️"
                  echo ""
                  echo "This workflow is DEPRECATED!"
                  echo ""
                  echo "Please use the new workflow: 'Promote Beta to Stable'"
                  echo ""
                  echo "New Workflow Flow:"
                  echo "  1. Create Beta Release (from staging)"
                  echo "  2. Publish Beta to NPM"
                  echo "  3. Promote Beta to Stable (from staging → main PR)"
                  echo "  4. Publish Stable to NPM (from main)"
                  echo ""
                  echo "See docs/RELEASE_WORKFLOW.md for complete documentation."

    create-stable-release:
        name: Create Stable Release (Deprecated)
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && github.event.inputs.confirm_stable == 'DEPRECATED_USE_PROMOTE_TO_STABLE'
        outputs:
            version: ${{ steps.convert_version.outputs.stable_version }}
            tag: ${{ steps.convert_version.outputs.tag }}

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js 22 and pnpm
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: 'https://registry.npmjs.org'

            - name: Enable corepack & install deps
              run: |
                  corepack enable
                  pnpm install --frozen-lockfile

            - name: Deprecation Notice
              run: |
                  echo "⚠️  WARNING: This workflow is deprecated!"
                  echo "Please use 'Promote Beta to Stable' workflow instead."
                  echo "Proceeding with deprecated workflow..."

            - name: Convert Beta to Stable Version
              id: convert_version
              run: |
                  cd packages/blend
                  CURRENT_VERSION=$(node -p "require('./package.json').version")

                  echo "Current version: $CURRENT_VERSION"

                  # Validate current version format
                  if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-beta(\.[0-9]+)?)?$ ]]; then
                    echo "ERROR: Invalid version format '$CURRENT_VERSION'. Expected format: X.Y.Z or X.Y.Z-beta.N"
                    exit 1
                  fi

                  # Check for new format: X.Y.Z-beta.N
                  if [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
                    STABLE_VERSION="${BASH_REMATCH[1]}"
                    BETA_NUMBER="${BASH_REMATCH[2]}"
                    echo "Converting beta to stable: $CURRENT_VERSION (beta #$BETA_NUMBER) → $STABLE_VERSION"
                  # Check for old format: X.Y.Z-beta
                  elif [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta$ ]]; then
                    STABLE_VERSION="${BASH_REMATCH[1]}"
                    echo "Converting beta to stable: $CURRENT_VERSION → $STABLE_VERSION"
                  # Already stable
                  else
                    STABLE_VERSION="$CURRENT_VERSION"
                    echo "Already stable version: $STABLE_VERSION"
                  fi

                  # Validate stable version format
                  if [[ ! "$STABLE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "ERROR: Invalid stable version format '$STABLE_VERSION'. Expected format: X.Y.Z"
                    exit 1
                  fi

                  # Update package.json with stable version
                  npm pkg set version="$STABLE_VERSION"

                  echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$STABLE_VERSION" >> $GITHUB_OUTPUT

                  # Verify the version was set correctly
                  UPDATED_VERSION=$(node -p "require('./package.json').version")
                  if [[ "$UPDATED_VERSION" != "$STABLE_VERSION" ]]; then
                    echo "ERROR: Failed to update package.json version. Expected '$STABLE_VERSION', got '$UPDATED_VERSION'"
                    exit 1
                  fi

                  echo "Version successfully updated in package.json to stable: $STABLE_VERSION"

            - name: Clean Existing Tags and Releases
              run: |
                  VERSION=${{ steps.convert_version.outputs.stable_version }}
                  TAG="v$VERSION"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  echo "Cleaning up any existing tags and releases for $TAG"

                  git tag -l | xargs -r git tag -d 2>/dev/null || true
                  git fetch --tags

                  if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
                    echo "Deleting existing remote tag $TAG"
                    git push origin ":refs/tags/$TAG" 2>/dev/null || true
                    sleep 2
                  fi

                  if gh release view "$TAG" >/dev/null 2>&1; then
                    echo "Deleting existing GitHub release $TAG"
                    gh release delete "$TAG" --yes 2>/dev/null || true
                    sleep 2
                  fi

                  git fetch --tags --prune --prune-tags
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate Stable Changelog
              run: |
                  VERSION=${{ steps.convert_version.outputs.stable_version }}

                  chmod +x scripts/generate-changelog.js
                  node scripts/generate-changelog.js "$VERSION" stable

                  echo "✅ Stable changelog generated successfully"

            - name: Format Generated Files
              run: |
                  pnpm format

            - name: Build Package
              run: pnpm --filter @juspay/blend-design-system build

            - name: Create Stable Release Tag
              run: |
                  VERSION=${{ steps.convert_version.outputs.stable_version }}
                  TAG="v$VERSION"

                  echo "Creating new stable tag $TAG"
                  git tag "$TAG" -m "Stable Release $TAG"

                  echo "Pushing tag $TAG to origin"
                  git push origin "$TAG"

                  echo "Successfully created and pushed stable tag $TAG"

            - name: Create GitHub Stable Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.convert_version.outputs.tag }}
                  name: Release ${{ steps.convert_version.outputs.tag }}
                  body_path: docs/CHANGELOG.md
                  draft: false
                  prerelease: false

            - name: Create Version Update PR to Dev
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  base: dev
                  branch: release/update-stable-version-${{ steps.convert_version.outputs.stable_version }}
                  title: 'chore(release): ${{ steps.convert_version.outputs.tag }} [STABLE - DEPRECATED WORKFLOW]'
                  body: |
                      ⚠️ **DEPRECATED WORKFLOW USED** ⚠️

                      This PR was created using the deprecated 'Create Stable Release' workflow.

                      **Recommended Approach:**
                      Please use the new workflow 'Promote Beta to Stable' for future releases.

                      See `docs/RELEASE_WORKFLOW.md` for the updated release process.

                      **Changes included:**
                      - Updated package.json version to stable (removed -beta)
                      - Generated stable changelog
                      - Created GitHub release (not prerelease)
                  labels: |
                      automated
                      release
                      stable
                      deprecated
                  assignees: ${{ github.actor }}
                  commit-message: |
                      chore(release): ${{ steps.convert_version.outputs.tag }} [STABLE - DEPRECATED]

                      - Convert to stable version ${{ steps.convert_version.outputs.stable_version }}
                      - Update changelog

                      [skip ci]
                  add-paths: |
                      packages/blend/package.json
                      docs/CHANGELOG.md
                      .
