name: Create Beta Release

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: 'Version bump type (only for first beta of a new version)'
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major
            increment_beta:
                description: 'Increment existing beta version (beta.0 â†’ beta.1, etc.)'
                required: true
                default: true
                type: boolean

concurrency:
    group: create-beta-release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    create-beta-release:
        name: Create Beta Release (No Publish)
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/staging'
        outputs:
            version: ${{ steps.bump_version.outputs.new_version }}
            tag: ${{ steps.bump_version.outputs.tag }}
            beta_number: ${{ steps.bump_version.outputs.beta_number }}

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js 22 and pnpm
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: 'https://registry.npmjs.org'

            - name: Enable corepack & install deps
              run: |
                  corepack enable
                  pnpm install --frozen-lockfile

            - name: Get Current Version and Calculate Beta Version
              id: bump_version
              run: |
                  cd packages/blend
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  VERSION_TYPE="${{ inputs.version_type }}"
                  INCREMENT_BETA="${{ inputs.increment_beta }}"

                  echo "Current version: $CURRENT_VERSION"
                  echo "Version type: $VERSION_TYPE"
                  echo "Increment beta: $INCREMENT_BETA"

                  # Validate version type
                  if [[ ! "$VERSION_TYPE" =~ ^(patch|minor|major)$ ]]; then
                    echo "ERROR: Invalid version type '$VERSION_TYPE'. Must be patch, minor, or major."
                    exit 1
                  fi

                  # Check if current version is already a beta with number (e.g., 0.0.1-beta.0)
                  if [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
                    BASE_VERSION="${BASH_REMATCH[1]}"
                    CURRENT_BETA_NUM="${BASH_REMATCH[2]}"
                    echo "Current is numbered beta: base=$BASE_VERSION, beta number=$CURRENT_BETA_NUM"
                    
                    if [[ "$INCREMENT_BETA" == "true" ]]; then
                      # Increment beta number
                      NEW_BETA_NUM=$((CURRENT_BETA_NUM + 1))
                      NEW_VERSION="${BASE_VERSION}-beta.${NEW_BETA_NUM}"
                      echo "Incremented beta number: $NEW_VERSION"
                    else
                      # Start new version with beta.0
                      echo "{\"version\": \"$BASE_VERSION\"}" > temp_package.json
                      NEW_BASE_VERSION=$(npm version "$VERSION_TYPE" --no-git-tag-version --prefix . 2>/dev/null | sed 's/^v//' || node -e "
                        const semver = require('semver');
                        const v = '$BASE_VERSION';
                        const type = '$VERSION_TYPE';
                        console.log(semver.inc(v, type));
                      ")
                      rm -f temp_package.json
                      
                      # Fallback calculation if npm version fails
                      if [[ -z "$NEW_BASE_VERSION" || "$NEW_BASE_VERSION" == "null" ]]; then
                        IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
                        case "$VERSION_TYPE" in
                          major) NEW_BASE_VERSION="$((MAJOR + 1)).0.0" ;;
                          minor) NEW_BASE_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
                          patch) NEW_BASE_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
                        esac
                      fi
                      
                      NEW_VERSION="${NEW_BASE_VERSION}-beta.0"
                      NEW_BETA_NUM=0
                      echo "Started new version with beta.0: $NEW_VERSION"
                    fi
                    
                  # Check if current version is old-style beta (e.g., 0.0.1-beta)
                  elif [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta$ ]]; then
                    BASE_VERSION="${BASH_REMATCH[1]}"
                    echo "Current is old-style beta: base=$BASE_VERSION"
                    
                    if [[ "$INCREMENT_BETA" == "true" ]]; then
                      # Convert old beta format to new format, start at beta.1
                      # (assuming old -beta was effectively beta.0)
                      NEW_VERSION="${BASE_VERSION}-beta.1"
                      NEW_BETA_NUM=1
                      echo "Converted old beta to new format: $NEW_VERSION"
                    else
                      # Start new version with beta.0
                      IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
                      case "$VERSION_TYPE" in
                        major) NEW_BASE_VERSION="$((MAJOR + 1)).0.0" ;;
                        minor) NEW_BASE_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
                        patch) NEW_BASE_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
                      esac
                      NEW_VERSION="${NEW_BASE_VERSION}-beta.0"
                      NEW_BETA_NUM=0
                      echo "Started new version with beta.0: $NEW_VERSION"
                    fi
                    
                  # Current version is stable (e.g., 0.0.1)
                  elif [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    BASE_VERSION="$CURRENT_VERSION"
                    echo "Current is stable version: $BASE_VERSION"
                    
                    # Always bump and start beta.0 for stable versions
                    IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
                    case "$VERSION_TYPE" in
                      major) NEW_BASE_VERSION="$((MAJOR + 1)).0.0" ;;
                      minor) NEW_BASE_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
                      patch) NEW_BASE_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
                    esac
                    NEW_VERSION="${NEW_BASE_VERSION}-beta.0"
                    NEW_BETA_NUM=0
                    echo "Created first beta for new version: $NEW_VERSION"
                    
                  else
                    echo "ERROR: Invalid version format '$CURRENT_VERSION'"
                    exit 1
                  fi

                  # Update package.json with new beta version
                  npm pkg set version="$NEW_VERSION"

                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "beta_number=$NEW_BETA_NUM" >> $GITHUB_OUTPUT

                  # Verify the version was set correctly
                  UPDATED_VERSION=$(node -p "require('./package.json').version")
                  if [[ "$UPDATED_VERSION" != "$NEW_VERSION" ]]; then
                    echo "ERROR: Failed to update package.json version. Expected '$NEW_VERSION', got '$UPDATED_VERSION'"
                    exit 1
                  fi

                  echo "Version successfully updated to $NEW_VERSION (beta.$NEW_BETA_NUM)"

            - name: Clean Existing Tags and Releases
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  TAG="v$VERSION"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  echo "Cleaning up any existing tags and releases for $TAG"

                  # Clean up any existing local tags
                  git tag -l | xargs -r git tag -d 2>/dev/null || true
                  git fetch --tags

                  # Force delete remote tag if it exists
                  if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
                    echo "Deleting existing remote tag $TAG"
                    git push origin ":refs/tags/$TAG" 2>/dev/null || true
                    sleep 2  # Wait for tag deletion to propagate
                  fi

                  # Delete existing GitHub release if it exists
                  echo "Checking for existing GitHub release $TAG"
                  if gh release view "$TAG" >/dev/null 2>&1; then
                    echo "Deleting existing GitHub release $TAG"
                    gh release delete "$TAG" --yes 2>/dev/null || true
                    sleep 2  # Wait for release deletion to propagate
                  fi

                  # Clean up local tags again after remote cleanup
                  git fetch --tags --prune --prune-tags
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate Changelog
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  BETA_NUMBER=${{ steps.bump_version.outputs.beta_number }}

                  # Make the changelog generator executable
                  chmod +x scripts/generate-changelog.js

                  # Generate changelog using the new script
                  node scripts/generate-changelog.js "$VERSION" beta

                  echo "âœ… Changelog generated successfully"

                  # Show preview
                  echo "ðŸ“‹ Changelog preview:"
                  head -20 docs/CHANGELOG.md

            - name: Format Generated Files
              run: |
                  pnpm format

            - name: Build Package
              run: pnpm --filter @juspay/blend-design-system build

            - name: Create Release Tag
              run: |
                  VERSION=${{ steps.bump_version.outputs.new_version }}
                  TAG="v$VERSION"

                  echo "Creating new tag $TAG"
                  git tag "$TAG" -m "Beta Release $TAG"

                  echo "Pushing tag $TAG to origin"
                  git push origin "$TAG"

                  echo "Successfully created and pushed tag $TAG"

            - name: Create GitHub Beta Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.bump_version.outputs.tag }}
                  name: Beta Release ${{ steps.bump_version.outputs.tag }}
                  body: |
                      ## ðŸ§ª Beta Release ${{ steps.bump_version.outputs.tag }}

                      **Beta Version:** `${{ steps.bump_version.outputs.new_version }}`
                      **Beta Number:** `${{ steps.bump_version.outputs.beta_number }}`

                      ### This is a pre-release version for testing purposes

                      Install this beta version:
                      ```bash
                      npm install @juspay/blend-design-system@${{ steps.bump_version.outputs.new_version }}
                      # or
                      npm install @juspay/blend-design-system@beta
                      ```

                      ### Changes
                      See the [CHANGELOG](docs/CHANGELOG.md) for detailed changes.

                      ### Beta Iteration
                      - This is beta iteration **#${{ steps.bump_version.outputs.beta_number }}**
                      - If issues are found, run the workflow again with "Increment existing beta version" checked
                      - When ready for stable release, promote using the stable release workflow
                  draft: false
                  prerelease: true

            - name: Create Version Update PR to Dev
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  base: dev
                  branch: release/update-beta-version-${{ steps.bump_version.outputs.new_version }}
                  title: 'chore(release): ${{ steps.bump_version.outputs.tag }} [BETA #${{ steps.bump_version.outputs.beta_number }}]'
                  body: |
                      ## Beta Release ${{ steps.bump_version.outputs.tag }}

                      **Beta Iteration:** #${{ steps.bump_version.outputs.beta_number }}
                      **Version:** ${{ steps.bump_version.outputs.new_version }}

                      ### Changes
                      - Bump version to ${{ steps.bump_version.outputs.new_version }}
                      - Update changelog
                      - **This is a BETA release from staging branch - ready for NPM publishing**

                      This PR was automatically created by the beta release workflow.

                      ### Next Steps (IMPORTANT - Follow in Order)
                      1. **Review and merge this PR to `dev` branch** (auto-created)
                      2. **Manually create PR from `dev` â†’ `staging`** and merge (syncs version back to staging)
                      3. **Trigger "Publish Beta to NPM" workflow** from `staging` branch
                      4. **Test the beta version thoroughly** using `npm install @juspay/blend-design-system@beta`
                      5. **If issues found**: Fix in `dev`, merge to `staging`, then run "Create Beta Release" with "Increment existing beta version" = `true`
                      6. **When stable**: Run "Promote Beta to Stable" workflow from `staging` branch

                      ### Beta Versioning System
                      - **First beta**: `X.Y.Z-beta.0` (increment_beta=false)
                      - **Subsequent betas**: `X.Y.Z-beta.1`, `X.Y.Z-beta.2`, etc. (increment_beta=true)
                      - **Stable release**: `X.Y.Z` (removes beta suffix, promoted via promote-to-stable workflow)

                      ### Release Branch Strategy
                      - Beta releases are created from `staging` branch
                      - Auto-created PR: `staging` â†’ `dev` (this PR)
                      - Manual PR required: `dev` â†’ `staging` (to sync version back)
                      - This ensures `dev` always has the latest version info
                      - Beta testing happens on `staging` branch
                      - Stable releases: `staging` â†’ `main` (via promote-to-stable workflow)
                  labels: |
                      automated
                      release
                      beta
                  assignees: ${{ github.actor }}
                  commit-message: |
                      chore(release): ${{ steps.bump_version.outputs.tag }} [BETA #${{ steps.bump_version.outputs.beta_number }}]

                      - Bump version to ${{ steps.bump_version.outputs.new_version }}
                      - Update changelog
                      - Create beta release from staging branch
                      - Beta iteration: #${{ steps.bump_version.outputs.beta_number }}

                      [skip ci]
                  add-paths: |
                      packages/blend/package.json
                      docs/CHANGELOG.md
                      .

            - name: Create Summary
              run: |
                  echo "## Beta Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Version** | \`${{ steps.bump_version.outputs.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Beta Number** | \`#${{ steps.bump_version.outputs.beta_number }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Tag** | \`${{ steps.bump_version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ“‹ Next Steps (Follow in Order)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "1. **Merge auto-created PR to \`dev\` branch**" >> $GITHUB_STEP_SUMMARY
                  echo "   - PR: \`staging\` â†’ \`dev\` (auto-created)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Create and merge PR from \`dev\` â†’ \`staging\`**" >> $GITHUB_STEP_SUMMARY
                  echo "   - This syncs the version back to staging branch" >> $GITHUB_STEP_SUMMARY
                  echo "   - Required before publishing to NPM" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "3. **Run 'Publish Beta to NPM' workflow** from \`staging\` branch" >> $GITHUB_STEP_SUMMARY
                  echo "   - Type \"PUBLISH\" to confirm" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "4. **Test the beta version**:" >> $GITHUB_STEP_SUMMARY
                  echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "   npm install @juspay/blend-design-system@beta" >> $GITHUB_STEP_SUMMARY
                  echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Beta Iteration Workflow" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**If issues are found during testing:**" >> $GITHUB_STEP_SUMMARY
                  echo "1. Fix issues in \`dev\` branch" >> $GITHUB_STEP_SUMMARY
                  echo "2. Create PR: \`dev\` â†’ \`staging\` and merge" >> $GITHUB_STEP_SUMMARY
                  echo "3. Run this workflow again with **'Increment existing beta version'** = \`true\`" >> $GITHUB_STEP_SUMMARY
                  echo "4. This will create: \`${{ steps.bump_version.outputs.new_version }}\` â†’ \`X.Y.Z-beta.$((steps.bump_version.outputs.beta_number + 1))\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**When ready for stable release:**" >> $GITHUB_STEP_SUMMARY
                  echo "- Run 'Promote Beta to Stable' workflow from \`staging\` branch" >> $GITHUB_STEP_SUMMARY
                  echo "- This creates PR: \`staging\` â†’ \`main\`" >> $GITHUB_STEP_SUMMARY
